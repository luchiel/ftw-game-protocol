Core
====

.. |username_format| replace:: [a-zA-Z0-9\_]{3,15}
.. |password_format| replace:: .{1,256}
.. |sid_format| replace:: [a-zA-Z0-9]{32}
.. |chat_message_format| replace:: .{1,256}

Введение
--------

Название расширения - core.v0


Конфигурационные параметры
--------------------------

+---------------+--------+-----------------------+
|    Название   |  Тип   |      Комментарий      |
+===============+========+=======================+
| websocket_url | string | URL WebSocket-сервера |
+---------------+--------+-----------------------+


Запросы, не требущие авторизации
--------------------------------

Регистрация нового пользователя (register)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Формат запроса:

+----------+--------+-------------------+-------------+
|   Поле   |  Тип   |       Формат      | Комментарий |
+==========+========+===================+=============+
| username | string | |username_format| | Имя         |
+----------+--------+-------------------+-------------+
| password | string | |password_format| | Пароль      |
+----------+--------+-------------------+-------------+

Коды ошибок:

+---------------------+--------------------------------------------+
|         Код         |                Комментарий                 |
+=====================+============================================+
| user_already_exists | Пользователь с таким именем уже существует |
+---------------------+--------------------------------------------+


Авторизация (login)
^^^^^^^^^^^^^^^^^^^

Формат запроса:

+----------+--------+-------------------+-------------+
|   Поле   |  Тип   |       Формат      | Комментарий |
+==========+========+===================+=============+
| username | string | |username_format| | Имя         |
+----------+--------+-------------------+-------------+
| password | string | |password_format| | Пароль      |
+----------+--------+-------------------+-------------+

Формат ответа:

+------+--------+--------------+-------------+
| Поле |  Тип   |    Формат    | Комментарий |
+======+========+==============+=============+
| sid  | string | |sid_format| | ID сессии   |
+------+--------+--------------+-------------+

Коды ошибок:

+---------------------+--------------------------------------+
|         Код         |             Комментарий              |
+=====================+======================================+
| invalid_credentials | Неверное имя пользователя или пароль |
+---------------------+--------------------------------------+


Запросы, требущие авторизации
-----------------------------

Каждый запрос этого типа должен содержать дополнительный параметр sid.

Общие поля:

+------+--------+--------------+-------------+
| Поле |  Тип   |    Формат    | Комментарий |
+======+========+==============+=============+
| sid  | string | |sid_format| | ID сессии   |
+------+--------+--------------+-------------+

Общие коды ошибок:

+-------------+----------------------------+
|     Код     |        Комментарий         |
+=============+============================+
| invalid_sid | Недействительный ID сессии |
+-------------+----------------------------+


Выход (logout)
^^^^^^^^^^^^^^

Запрос не содержит каких-либо параметров.


Отправка сообщения в чат (send_message)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Формат запроса:

+---------+---------+-----------------------+-------------+
|   Поле  |   Тип   |         Формат        | Комментарий |
+=========+=========+=======================+=============+
| game_id | integer |                       | ID игры     |
+---------+---------+-----------------------+-------------+
| message | string  | |chat_message_format| | Сообщение   |
+---------+---------+-----------------------+-------------+


Создание игры (create_game)
^^^^^^^^^^^^^^^^^^^^^^^^^^^

Формат запроса:

+----------+--------+---------------------+---------------+
|   Поле   |  Тип   |        Формат       |  Комментарий  |
+==========+========+=====================+===============+
| name     | string | [a-zA-Z0-9\_]{3,32} | Название игры |
+----------+--------+---------------------+---------------+
| password | string | .{0,256}            | Пароль        |
+----------+--------+---------------------+---------------+

Формат ответа:

+---------+---------+----------+-------------+
|   Поле  |   Тип   |  Формат  | Комментарий |
+=========+=========+==========+=============+
| game_id | integer |          | ID игры     |
+---------+---------+----------+-------------+


Подключение к игре (join_game)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Формат запроса:

+----------+---------+----------+-------------+
|   Поле   |   Тип   |  Формат  | Комментарий |
+==========+=========+==========+=============+
| game_id  | integer |          | ID игры     |
+----------+---------+----------+-------------+
| password | string  | .{0,256} | Пароль      |
+----------+---------+----------+-------------+

Коды ошибок:

+----------------------+--------------------------------------------+
|         Код          |                Комментарий                 |
+======================+============================================+
| already_in_game      | Пользователь уже находится в какой-то игре |
+----------------------+--------------------------------------------+
| game_not_found       | Игра не существует                         |
+----------------------+--------------------------------------------+
| game_already_started | Игра уже началась                          |
+----------------------+--------------------------------------------+
| wrong_game_password  | Неверный пароль                            |
+----------------------+--------------------------------------------+


Выход из игры (leave_game)
^^^^^^^^^^^^^^^^^^^^^^^^^^

Коды ошибок:

+-------------+----------------------------------+
|     Код     |           Комментарий            |
+=============+==================================+
| not_in_game | Пользователь находится не в игре |
+-------------+----------------------------------+


Запуск игры (start_game)
^^^^^^^^^^^^^^^^^^^^^^^^

Игра начинается после того, как все её участники отправили это сообщение.

Коды ошибок:

+----------------------+----------------------------------+
|         Код          |           Комментарий            |
+======================+==================================+
| game_already_started | Игра уже началась                |
+----------------------+----------------------------------+
| not_in_game          | Пользователь находится не в игре |
+----------------------+----------------------------------+


События, генерируемые сервером (WebSocket)
------------------------------------------

Новое сообщение чата (new_message)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Формат:

+-----------+---------+-----------------------+---------------------------+
|    Поле   |   Тип   |         Формат        |        Комментарий        |
+===========+=========+=======================+===========================+
| text      | string  | |chat_message_format| | Текст сообщения           |
+-----------+---------+-----------------------+---------------------------+
| username  | string  | |username_format|     | Автор сообщения           |
+-----------+---------+-----------------------+---------------------------+
| timestamp | integer | unixtime              | Время написания сообщения |
+-----------+---------+-----------------------+---------------------------+


Игрок подключился к игре (player_joined_game)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Формат:

+----------+--------+-------------------+------------------+
|   Поле   |  Тип   |       Формат      |   Комментарий    |
+==========+========+===================+==================+
| username | string | |username_format| | Имя пользователя |
+----------+--------+-------------------+------------------+


Игрок вышел из игры (player_left_game)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Формат:

+----------+--------+-------------------+------------------+
|   Поле   |  Тип   |       Формат      |   Комментарий    |
+==========+========+===================+==================+
| username | string | |username_format| | Имя пользователя |
+----------+--------+-------------------+------------------+


Игра началась (game_started)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^


Ошибка авторизации (auth_error)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Эта ошибка приходит только в ответ на событие auth. Сервер должен закрыть соединение сразу после генерации этого события.


События, генерируемые клиентом (WebSocket)
------------------------------------------

Авторизация (auth)
^^^^^^^^^^^^^^^^^^

Формат:

+------+--------+--------------+-------------+
| Поле |  Тип   |    Формат    | Комментарий |
+======+========+==============+=============+
| sid  | string | |sid_format| | ID сессии   |
+------+--------+--------------+-------------+
